/*
 * JS for createAccount generated by Appery.io
 *
 * Created on: Saturday, April 27, 2013, 10:08:51 AM (PDT)
 */

/* Setting project environment indicator */
Appery.env = "apk";

Appery.getProjectGUID = function() {
    return '718cfd69-900a-4443-a5ae-209e0828fa3c';
}

Appery.getTargetPlatform = function() {
    return 'A';
}

function navigateTo(outcome, useAjax) {
    Appery.navigateTo(outcome, useAjax);
}

function adjustContentHeight() {
    Appery.adjustContentHeight();
}

function adjustContentHeightWithPadding() {
    Appery.adjustContentHeightWithPadding();
}

function setDetailContent(pageUrl) {
    Appery.setDetailContent(pageUrl);
}

/*
 * Services
 */
var activityProducts = new Appery.RestService({
    'url': 'http://192.168.1.5:8080/tun-industry/productses/activity/',
    'dataType': 'json',
    'type': 'get',
});
var allSectors = new Appery.RestService({
    'url': 'http://192.168.1.5:8080/tun-industry/sectors/all',
    'dataType': 'json',
    'type': 'get',
});
var createAccount = new Appery.RestService({
    'url': 'http://192.168.1.5:8080/tun-industry/appusers/createAccount',
    'dataType': 'json',
    'type': 'post',
    'contentType': 'application/json',
});
var companies = new Appery.RestService({
    'url': 'http://192.168.1.5:8080/tun-industry/companys/search',
    'dataType': 'json',
    'type': 'get',
});
var company = new Appery.RestService({
    'url': 'http://192.168.1.5:8080/tun-industry/companys/find/',
    'dataType': 'json',
    'type': 'get',
});
var sectorBranches = new Appery.RestService({
    'url': 'http://192.168.1.5:8080/tun-industry/activitybranches/sector/',
    'dataType': 'json',
    'type': 'get',
});
var userFavorites = new Appery.RestService({
    'url': 'http://192.168.1.5:8080/tun-industry/appusers/userFovorites',
    'dataType': 'json',
    'type': 'get',
});
var SubscribedCompanyNum = new Appery.RestService({
    'url': 'http://192.168.1.5:8080/tun-industry/companys/num',
    'dataType': 'json',
    'type': 'get',
});
var authenticate = new Appery.RestService({
    'url': 'http://192.168.1.5:8080/tun-industry/appusers/authtication',
    'dataType': 'json',
    'type': 'post',
    'contentType': 'application/x-www-form-urlencoded',
});

//createSpinner("res/lib/jquerymobile/images/ajax-loader.gif");
Appery.AppPages = [{
    "name": "createAccount",
    "location": "createAccount.html"
}, {
    "name": "login",
    "location": "login.html"
}, {
    "name": "startScreen",
    "location": "startScreen.html"
}];

j_0_js = function(runBeforeShow) { /* Object & array with components "name-to-id" mapping */
    var n2id_buf = {
        'signIn': 'j_4',
        'spacer_3': 'j_5',
        'error': 'j_11',
        'login': 'j_6',
        'email': 'j_7',
        'password': 'j_8',
        'spacer_9': 'j_9',
        'submit': 'j_10'
    };

    if ("n2id" in window && window.n2id !== undefined) {
        $.extend(n2id, n2id_buf);
    } else {
        window.n2id = n2id_buf;
    }

    Appery.CurrentScreen = 'j_0';

    /*
     * Nonvisual components
     */
    var datasources = [];

    createAccountService = new Appery.DataSource(createAccount, {
        'onComplete': function(jqXHR, textStatus) {

            $t.refreshScreenFormElements("j_0");
        },
        'onSuccess': function(data) {},
        'onError': function(jqXHR, textStatus, errorThrown) {},
        'responseMapping': [],
        'requestMapping': [{
            'PATH': ['login'],
            'ID': 'login',
            'ATTR': 'value'
        }, {
            'PATH': ['email'],
            'ID': 'email',
            'ATTR': 'value'
        }, {
            'PATH': ['password'],
            'ID': 'password',
            'ATTR': 'value'
        }]
    });

    datasources.push(createAccountService);

    /*
     * Events and handlers
     */
    j_0_beforeshow = function() {
        Appery.CurrentScreen = 'j_0';
        for (var idx = 0; idx < datasources.length; idx++) {
            datasources[idx].__setupDisplay();
        }
    }
    // screen onload
    screen_0CCC_onLoad = j_0_onLoad = function() {
        screen_0CCC_elementsExtraJS();

        j_0_deviceEvents();
        j_0_windowEvents();
        screen_0CCC_elementsEvents();
    }

    // screen window events
    screen_0CCC_windowEvents = j_0_windowEvents = function() {
        $('#j_0').bind('pageshow orientationchange', function() {
            adjustContentHeightWithPadding();
        });

    }

    // device events
    j_0_deviceEvents = function() {

        document.addEventListener("deviceready", function() {

        });
    }

    // screen elements extra js
    screen_0CCC_elementsExtraJS = j_0_elementsExtraJS = function() {
        // screen (screen-0CCC) extra code

    }
    
    function isNetworkAvailable() {
    	var networkState = navigator.network.connection.type;

    	var states = {};
    	states[Connection.UNKNOWN] = 'Unknown connection';
    	states[Connection.ETHERNET] = 'Ethernet connection';
    	states[Connection.WIFI] = 'WiFi connection';
    	states[Connection.CELL_2G] = 'Cell 2G connection';
    	states[Connection.CELL_3G] = 'Cell 3G connection';
    	states[Connection.CELL_4G] = 'Cell 4G connection';
    	states[Connection.NONE] = 'No network connection';

    	if ((states[networkState] == 'No network connection')
    			|| (states[networkState] == 'Unknown connection')) {
    		return true;
    	} else {
    		return true;
    	}
    }
    
    function createAccount(){
    	$("#j_11").toggle(false);
    	$("#j_11").empty();
    	$("#j_6").css("border", "none");
    	$("#j_7").css("border", "none");
    	$("#j_8").css("border", "none");
    	$("#j_10").attr('disabled');
    	 var createAccountUrl = "http://192.168.1.5:8080/tun-industry/appusers/createAccount";
    		
    		var l = $("#j_6").val();
    		var e = $("#j_7").val();
    		var p = $("#j_8").val();

    		if (l != '' && l.length > 3 && l.length < 26 && e != '' && e.length > 5 && l.length < 80 && p != '' && p.length > 3
    				&& p.length < 21) {
    			if (isNetworkAvailable()) {
    				try {
    					$.post( createAccountUrl, { login : l, email : e, password : p} ).done(
    									function(result) {
    										if (result.status != 400) {
    											$("#j_10").removeAttr(
    													"disabled"); 
    											window.localStorage.setItem("userId",
    													result.id);
    											window.localStorage.setItem("userName",
    													result.userName);
    											window.localStorage.setItem("email",
    													result.email);
    											window.localStorage.setItem("password",
    													result.password);
    											window.localStorage.setItem(
    													"isUserLogged", true);
    											Appery.navigateTo('startScreen', {
    						                        transition: 'slidedown',
    						                        reverse: false
    						                    });
    											
    										} else {
    											window.localStorage.setItem(
    													"isUserLogged", false);
    											navigator.notification.alert(
    													'Login failed. Try again',
    													null, 'Error', 'Done');
    											return;
    										}
    									})
    							.fail(
    									function(error) {
    										if(error.status == 400) {
    											$("#j_11").empty();
    											$("#j_11").toggle(true);
    							    			$("#j_11").css("color", "red");
    							    			$("#j_11").append("<p> Somthing went wrong. Please recheck your information</p>");
    											$("#j_6").css("border", "1px solid red");
    											$("#j_7").css("border", "1px solid red");
    											$("#j_8").css("border", "1px solid red");
    											
    										} else {
	    										navigator.notification
	    												.alert(
	    														'Error. Could not contact the server.',
	    														null, 'Error', 'Done');
    										}
    									});

    				} catch (e) {
    					navigator.notification.alert(
    							'Login failed. Could not contact the server.', null,
    							'Error', 'Done');
    				}
    			} else {
    				navigator.notification.alert(
    						'Login failed. Check your internet connection', null,
    						'Error', 'Done');
    			}
    		} else {
    			$("#j_11").toggle(true);
    			$("#j_11").css("color", "red");

    			if (l.length == 0) {
    				$("#j_6").css("border", "1px solid red");
    				$("#j_11").append("<p> Login is required</p>");
    			} else if (l != '' && (l.length < 4 || l.length > 25)) {
    				$("#j_6").css("border", "1px solid red");
    				$("#j_11").append(
    						"<p> Login length must be more then 4 characters</p>");

    			}
    			
    			if (e.length == 0) {
    				$("#j_7").css("border", "1px solid red");
    				$("#j_11").append("<p> E-mail is required</p>");
    			} else if (l != '' && (l.length < 4 || l.length > 25)) {
    				$("#j_7").css("border", "1px solid red");
    				$("#j_11").append(
    						"<p> E-mail length must be more then 5 characters</p>");

    			}
    			
    			if (p.length == 0) {
    				$("#j_8").css("border", "1px solid red");
    				$("#j_11").append("<p> Password is required</p>");
    			} else if (p != '' && (p.length < 4 || p.length > 20)) {
    				$("#j_8").css("border", "1px solid red");
    				$("#j_11").append(
    						"<p> Password length must be more then 4 characters</p>");

    			}
    		}
    }

    // screen elements handler
    screen_0CCC_elementsEvents = j_0_elementsEvents = function() {

        $("a :input,a a,a fieldset label").live({
            click: function(event) {
                event.stopPropagation();
            }
        });

        $('#j_3 [name="submit"]').die().live({
            click: function() {
                if (!$(this).attr('disabled')) {
                	createAccount();
                }
            },
        });

    }

    $("#j_0").die("pagebeforeshow").live("pagebeforeshow", function(event, ui) {
        j_0_beforeshow();
    });

    if (runBeforeShow) {
        j_0_beforeshow();
    } else {
        j_0_onLoad();
    }

}

$("#j_0").die("pageinit").live("pageinit", function(event, ui) {
    Appery.processSelectMenu($(this));
    j_0_js();
});