/*
 * JS for login generated by Appery.io
 *
 * Created on: Saturday, April 27, 2013, 10:08:51 AM (PDT)
 */

/* Setting project environment indicator */
Appery.env = "apk";

Appery.getProjectGUID = function() {
    return '718cfd69-900a-4443-a5ae-209e0828fa3c';
}

Appery.getTargetPlatform = function() {
    return 'A';
}

function navigateTo(outcome, useAjax) {
    Appery.navigateTo(outcome, useAjax);
}

function adjustContentHeight() {
    Appery.adjustContentHeight();
}

function adjustContentHeightWithPadding() {
    Appery.adjustContentHeightWithPadding();
}

function setDetailContent(pageUrl) {
    Appery.setDetailContent(pageUrl);
}

/*
 * Services
 */
var activityProducts = new Appery.RestService({
    'url': 'http://192.168.1.5:8080/tun-industry/productses/activity/',
    'dataType': 'json',
    'type': 'get',
});
var allSectors = new Appery.RestService({
    'url': 'http://192.168.1.5:8080/tun-industry/sectors/all',
    'dataType': 'json',
    'type': 'get',
});
var createAccount = new Appery.RestService({
    'url': 'http://192.168.1.5:8080/tun-industry/appusers/createAccount',
    'dataType': 'json',
    'type': 'post',
    'contentType': 'application/json',
});
var companies = new Appery.RestService({
    'url': 'http://192.168.1.5:8080/tun-industry/companys/search',
    'dataType': 'json',
    'type': 'get',
});
var company = new Appery.RestService({
    'url': 'http://192.168.1.5:8080/tun-industry/companys/find/',
    'dataType': 'json',
    'type': 'get',
});
var sectorBranches = new Appery.RestService({
    'url': 'http://192.168.1.5:8080/tun-industry/activitybranches/sector/',
    'dataType': 'json',
    'type': 'get',
});
var userFavorites = new Appery.RestService({
    'url': 'http://192.168.1.5:8080/tun-industry/appusers/userFovorites',
    'dataType': 'json',
    'type': 'get',
});
var SubscribedCompanyNum = new Appery.RestService({
    'url': 'http://192.168.1.5:8080/tun-industry/companys/num',
    'dataType': 'json',
    'type': 'get',
});
var authenticate = new Appery.RestService({
    'url': 'http://192.168.1.5:8080/tun-industry/appusers/authentication',
    'dataType': 'json',
    'type': 'get',
});

//createSpinner("res/lib/jquerymobile/images/ajax-loader.gif");
Appery.AppPages = [{
    "name": "createAccount",
    "location": "createAccount.html"
}, {
    "name": "login",
    "location": "login.html"
}, {
    "name": "sectors",
    "location": "sectors.html"
}];

j_15_js = function(runBeforeShow) { /* Object & array with components "name-to-id" mapping */
    var n2id_buf = {
        'mobilelabel_4': 'j_19',
        'mobilelabel_26': 'j_31',
        'userLogin': 'j_22',
        'password': 'j_23',
        'mobilecheckboxgroup_9': 'j_20',
        'rememberMe': 'j_21',
        'spacer_16': 'j_24',
        'loginButton': 'j_25',
        'mobilegrid_18': 'j_26',
        'mobilegridcell_19': 'j_27',
        'signIn': 'j_28',
        'mobilegridcell_20': 'j_29',
        'skip': 'j_30'
    };

    if ("n2id" in window && window.n2id !== undefined) {
        $.extend(n2id, n2id_buf);
    } else {
        window.n2id = n2id_buf;
    }

    Appery.CurrentScreen = 'j_15';

    /*
     * Nonvisual components
     */
    var datasources = [];

    authenticateService = new Appery.DataSource(authenticate, {
        'onComplete': function(jqXHR, textStatus) {

            $t.refreshScreenFormElements("j_15");
        },
        'onSuccess': function(data) {},
        'onError': function(jqXHR, textStatus, errorThrown) {},
        'responseMapping': [],
        'requestMapping': [{
            'PATH': ['login'],
            'ID': 'userLogin',
            'ATTR': 'value',
            'TRANSFORMATION': function(value) {
                return value || "";
            }
        }, {
            'PATH': ['password'],
            'ID': 'password',
            'ATTR': 'value',
            'TRANSFORMATION': function(value) {
                return value || "";
            }
        }]
    });

    datasources.push(authenticateService);

    /*
     * Events and handlers
     */
    j_15_beforeshow = function() {
        Appery.CurrentScreen = 'j_15';
        for (var idx = 0; idx < datasources.length; idx++) {
            datasources[idx].__setupDisplay();
        }
    }
    // screen onload
    screen_7F06_onLoad = j_15_onLoad = function() {
        screen_7F06_elementsExtraJS();

        j_15_deviceEvents();
        j_15_windowEvents();
        screen_7F06_elementsEvents();
    }

    // screen window events
    screen_7F06_windowEvents = j_15_windowEvents = function() {
        $('#j_15').bind('pageshow orientationchange', function() {
            adjustContentHeightWithPadding();
        });

    }

    // device events
    j_15_deviceEvents = function() {

        document.addEventListener("deviceready", function() {

        });
    }

    // screen elements extra js
    screen_7F06_elementsExtraJS = j_15_elementsExtraJS = function() {
        // screen (screen-7F06) extra code

    }
    
    function isNetworkAvailable() {
    	var networkState = navigator.network.connection.type;

    	var states = {};
    	states[Connection.UNKNOWN] = 'Unknown connection';
    	states[Connection.ETHERNET] = 'Ethernet connection';
    	states[Connection.WIFI] = 'WiFi connection';
    	states[Connection.CELL_2G] = 'Cell 2G connection';
    	states[Connection.CELL_3G] = 'Cell 3G connection';
    	states[Connection.CELL_4G] = 'Cell 4G connection';
    	states[Connection.NONE] = 'No network connection';

    	if ((states[networkState] == 'No network connection')
    			|| (states[networkState] == 'Unknown connection')) {
    		return true;
    	} else {
    		return true;
    	}
    }
    
    function doLogin() {
    	$("#j_31").toggle(false);
    	$("#j_31").empty();
    	$("#j_22").css("border", "none");
    	$("#j_23").css("border", "none");
    	$("#j_25").attr('disabled');
    	 var loginUrl = "http://192.168.1.5:8080/tun-industry/appusers/authentication";
    		
    		var l = $("#j_22").val();
    		var p = $("#j_23").val();

    		if (l != '' && l.length > 3 && l.length < 26 && p != '' && p.length > 3
    				&& p.length < 21) {
    			if (isNetworkAvailable()) {
    				try {
    					$.post( loginUrl, { login : l, password : p} ).done(
    									function(result) {
    										if (result.status != 401) {
    											$("#j_25").removeAttr(
    													"disabled"); 
    											window.localStorage.setItem("userId",
    													result.id);
    											window.localStorage.setItem("userName",
    													result.userName);
    											window.localStorage.setItem("email",
    													result.email);
    											window.localStorage.setItem("password",
    													result.password);
    											window.localStorage.setItem("password",
    													result.password);
    											window.localStorage.setItem("rememberMe",
    													$('#j_21').is(':checked'));
    											window.localStorage.setItem(
    													"isUserLogged", true);
    											Appery.navigateTo('sectors', {
    						                        transition: 'slidedown',
    						                        reverse: false
    						                    });
    											
    										} else {
    											window.localStorage.setItem(
    													"isUserLogged", false);
    											navigator.notification.alert(
    													'Login failed. Try again',
    													null, 'Error', 'Done');
    											return;
    										}
    									})
    							.fail(
    									function(error) {
    										if(error.status == 401) {
    											$("#j_31").empty();
    											$("#j_31").toggle(true);
    							    			$("#j_31").css("color", "red");
    							    			$("#j_31").append("<p> Login or password are incorrect</p>");
    											$("#j_22").css("border", "1px solid red");
    											$("#j_23").css("border", "1px solid red");
    											
    										} else {
	    										navigator.notification
	    												.alert(
	    														'Error. Could not contact the server.',
	    														null, 'Error', 'Done');
    										}
    									});

    				} catch (e) {
    					navigator.notification.alert(
    							'Login failed. Could not contact the server.', null,
    							'Error', 'Done');
    				}
    			} else {
    				navigator.notification.alert(
    						'Login failed. Check your internet connection', null,
    						'Error', 'Done');
    			}
    		} else {
    			$("#j_31").toggle(true);
    			$("#j_31").css("color", "red");

    			if (l.length == 0) {
    				$("#j_22").css("border", "1px solid red");
    				$("#j_31").append("<p> Login is required</p>");
    			} else if (l != '' && (l.length < 4 || l.length > 25)) {
    				$("#j_22").css("border", "1px solid red");
    				$("#j_31").append(
    						"<p> Login length must be more then 4 characters</p>");

    			}
    			if (p.length == 0) {
    				$("#j_23").css("border", "1px solid red");
    				$("#j_31").append("<p> Password is required</p>");
    			} else if (p != '' && (p.length < 4 || p.length > 20)) {
    				$("#j_23").css("border", "1px solid red");
    				$("#j_31").append(
    						"<p> Password length must be more then 4 characters</p>");

    			}
    		}

    }

    // screen elements handler
    screen_7F06_elementsEvents = j_15_elementsEvents = function() {

        $("a :input,a a,a fieldset label").live({
            click: function(event) {
                event.stopPropagation();
            }
        });

        $('#j_18 [name="rememberMe"]').die().live({
            click: function() {
                if (!$(this).attr('disabled')) {
                    setVar_('rememberMe', 'j_21', 'checkboxSelected', '', this);

                }
            },
        });

        $('#j_18 [name="loginButton"]').die().live({
            click: function() {
                if (!$(this).attr('disabled')) {
                	doLogin();
                }
            },
        });

        $('#j_18 [name="signIn"]').die().live({
            click: function() {
                if (!$(this).attr('disabled')) {
                    Appery.navigateTo('createAccount', {
                        transition: 'flip',
                        reverse: false
                    });

                }
            },
        });

        $('#j_18 [name="skip"]').die().live({
            click: function() {
                if (!$(this).attr('disabled')) {
                    Appery.navigateTo('sectors', {
                        transition: 'fade',
                        reverse: false
                    });

                }
            },
        });

    }

    $("#j_15").die("pagebeforeshow").live("pagebeforeshow", function(event, ui) {
        j_15_beforeshow();
    });

    if (runBeforeShow) {
        j_15_beforeshow();
    } else {
        j_15_onLoad();
    }

}

$("#j_15").die("pageinit").live("pageinit", function(event, ui) {
    Appery.processSelectMenu($(this));
    j_15_js();
});